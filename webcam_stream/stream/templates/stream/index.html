<!DOCTYPE html>
<html lang="en">
<head>
    {% load static %}
    <meta charset="UTF-8">
    <title>Custom Map with Moving Objects</title>
    <style>
        body {
            background-color: #f3f3f3;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        #mapCanvas {
            border: 2px solid #ccc;
        }
    </style>
</head>
<body>
    <canvas id="mapCanvas" width="640" height="640"></canvas>

    <script>
        const canvas = document.getElementById('mapCanvas');
        const ctx = canvas.getContext('2d');

        // 지도 이미지 로드
        const mapImage = new Image();
        mapImage.src = "{% static 'map_img.jpg' %}"; // 커스텀 지도 이미지 경로

        // 카메라(고정된 마커) 위치 설정
        const cameraPosition = { x: 320, y: 320 }; // 예시로 중앙에 카메라 위치 설정

        // 카메라 마커 이미지 로드
        const cameraMarkerImage = new Image();
        cameraMarkerImage.src = 'https://cdn-icons-png.flaticon.com/512/747/747376.png'; // 고정 카메라 마커 이미지 URL

        // 움직이는 물체의 경로와 마커 정보
        const path = [];  // 물체의 경로 저장
        const movingMarkerImage = new Image();
        movingMarkerImage.src = 'https://cdn-icons-png.flaticon.com/512/7334/7334593.png'; // 움직이는 물체 마커 이미지 URL
        let objectPosition = { x: 100, y: 100 };  // 물체의 초기 위치

        mapImage.onload = function() {
            // 지도 이미지가 로드되면 캔버스에 그리기
            drawMapAndPath();
        };

        // 경로와 마커를 그리는 함수
        function drawMapAndPath() {
            // 배경 지도와 경로, 마커 모두 다시 그리기
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(mapImage, 0, 0, canvas.width, canvas.height);

            // 고정 카메라 마커 그리기
            ctx.drawImage(cameraMarkerImage, cameraPosition.x - 15, cameraPosition.y - 15, 30, 30); // 마커의 중앙이 좌표에 맞도록 조정

            // 경로 그리기
            if (path.length > 1) {
                ctx.beginPath();
                ctx.moveTo(path[0].x, path[0].y);
                for (let i = 1; i < path.length; i++) {
                    ctx.lineTo(path[i].x, path[i].y);
                }
                ctx.strokeStyle = '#FF0000'; // 경로 색상
                ctx.lineWidth = 3; // 경로 두께
                ctx.stroke();
            }

            // 움직이는 물체 마커 그리기 (마커를 경로의 현재 위치에 표시)
            ctx.drawImage(movingMarkerImage, objectPosition.x - 10, objectPosition.y - 10, 20, 20); // 물체 마커 그리기
        }

        // 물체의 위치를 업데이트하는 함수
        function updateObjectPosition(newPosition) {
            path.push(newPosition);  // 새로운 좌표를 경로에 추가
            objectPosition = newPosition;  // 물체의 현재 위치 업데이트
            drawMapAndPath();  // 경로와 마커 다시 그리기
        }

        // 주기적으로 서버에서 좌표 받아와서 물체의 위치 업데이트
        setInterval(function() {
            fetch('/get_object_location/')  // 서버로부터 좌표 받아오기
                .then(response => response.json())
                .then(data => {
                    const newPos = { x: data.x, y: data.y };  // 받은 좌표로 객체 생성
                    updateObjectPosition(newPos);  // 물체 위치 업데이트
                });
        }, 2000);  // 2초마다 좌표 업데이트
    </script>
</body>
</html>
